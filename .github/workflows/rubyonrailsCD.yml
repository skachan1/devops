# This workflow uses actions that are not certified by GitHub.  They are
# provided by a third-party and are governed by separate terms of service,
# privacy policy, and support documentation.
#
# This workflow will install a prebuilt Ruby version, install dependencies, and
# run tests and linters.
name: "Ruby on Rails CD"
on:
  workflow_call:
jobs:
  build_and_push:
    runs-on: ubuntu-latest
    env:
      REPO_NAME: ${{ github.event.repository.name }}
    steps:
      - name: Login to docker.io
        run: docker login -u ${{ secrets.DOCKER_HUB_USERNAME }} -p ${{ secrets.DOCKER_HUB_PASSWORD }}
      
      - name: Get repository code
        uses: actions/checkout@v3

      - name: "Set TAG environmental variable"
        run: |
          echo "TAG=${{ secrets.DOCKER_HUB_USERNAME }}/$REPO_NAME:${GITHUB_REF:11}-${GITHUB_SHA}" >> $GITHUB_ENV

      - name: Build image
        run: docker build -t $TAG -f Dockerfile .

      - name: Tag latest
        run: docker tag $TAG ${{ secrets.DOCKER_HUB_USERNAME }}/$REPO_NAME:active
      
      - name: Push image to docker.io
        run: |
          docker push $TAG
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/$REPO_NAME:active
        
      - name: Logout from docker.io
        run: docker logout
  
  deploy:
    needs: [build_and_push]
    runs-on: ubuntu-latest
    env:
      REPO_NAME: ${{ github.event.repository.name }}
    steps:
      - name: Create directory
        run: mkdir -p ~/.ssh/

      - name: Create secret_key
        run: echo "${{ secrets.BASTYON_PRIV_KEY }}" >> ~/.ssh/id_rsa

      - name: Chmod
        run: chmod 600 ~/.ssh/id_rsa

      - name: Keyscan
        run: ssh-keyscan -H ${{ secrets.BASTYON_ADDR }} > ~/.ssh/known_hosts

      - name: ssh
        run: |
          ssh skachan@${{ secrets.BASTYON_ADDR }} "export YC_TOKEN=${{ secrets.YC_TOKEN }} && bash check_state.bash && ansible-playbook -i terraform-inventory ./ansible/$REPO_NAME.yml"
